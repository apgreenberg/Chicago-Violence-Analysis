<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
<style> /* set the CSS */

.line {
  fill: none;
  stroke-width: 3px;
}

.police {
  stroke: steelblue;
}
.violent {
  stroke: red;
}
.other {
  stroke: #ff4f2a;
}
.social {
  stroke: #00cc88;
}

.lineLabel {
  display:none;
  color:black;
  text-anchor:middle;
}

.text {
  font-size: 16px;
}

.dataLabel {
  background-color: #f18973;
}

</style>
</head>
<body>
<h1>
  Examining the Correlation Between Police Funding, Social Services, and Crime in Chicago.
</h1>
<div id="topChartLineLabel">No Line Selected</div>

<!-- load the d3.js library -->   
<script src ="toplevdata.js"> </script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

var secondGraphLoaded = 0;
var colors = ["steelblue", "red", "#ff4f2a", "#00cc88"];

function highlight(name) {
  id = "#"+name+"Line";
  console.log(id);
  d3.selectAll('.line')
  .style("stroke", "gainsboro");
  d3.select(id)
  .style("stroke", "black")
  .style("stroke-width", "6px");
  console.log("made it to tooltip");
  d3.select('.d3-tip')
    .html(function(d) {
    return "<strong>Category:</strong> <span style='color:" + colors[titleMapping.get(id).num] + "'>" + titleMapping.get(id).category + "</span>";})
  console.log("made it past tooltip");
  //.append("text")
  //.text(titleMapping.get(id).desc);
  d3.select("#topChartLineLabel")
  .text(titleMapping.get(id).desc);

}

function displayTip(id) {
  d3.select('.tooltip')
      .attr("x","430")
      .attr("y","20")
      .attr("display", "block")
      .html("<strong>Category:</strong> <span style='color:" + colors[titleMapping.get(id).num] + "'>" + titleMapping.get(id).category + "</span>");
}

function dehighlight() {
  d3.selectAll('.line')
  .style("stroke", null)
  .style("stroke-width", null);
  d3.select("#topChartLineLabel")
  .text('No Line Selected');
}

// set the dimensions and margins of the graph
var margin = {top: 50, right: 50, bottom: 50, left: 50},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// parse the date / time
var parseTime = d3.timeParse("%Y");

// define the 1st line
var policeline = d3.line()
    .x(function(d) { return x(d.year); })
    .y(function(d) { return y(d.police); });

// define the 2nd line
var violentline = d3.line()
    .x(function(d) { return x(d.year); })
    .y(function(d) { return y(d.violent); });

var otherline = d3.line()
    .x(function(d) { return x(d.year); })
    .y(function(d) { return y(d.other); });

var socialline = d3.line()
    .x(function(d) { return x(d.year); })
    .y(function(d) { return y(d.social); });

// append the svg obgect to the body of the page
// appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

  // format the data
  origData.forEach(function(d) {
      d.values.forEach(function(d) {
        d.year = parseTime(d.year);
        d.percent = +d.percent;
      });
  });

  // Scale the range of the data
  // set the ranges
  var x = d3.scaleTime()
    .domain(d3.extent(origData[0].values, d => d.year))
    .range([0, width]);

  var y = d3.scaleLinear()
    .domain([d3.min(origData[3].values, d=>d.percent), d3.max(origData[3].values, d=>d.percent)])
    .range([height, 0]);

  svg.append("text")
    .attr("x", width/2)
    .attr("y", height+35)
    .style("text-anchor", "middle")
    .text("Year");

   svg.append("text")
    .attr("x", -70)
    .attr("y", 15)
    .attr("transform", "rotate(-90)")
    .style("text-anchor", "middle")
    .text("% change since previous year");

  svg.append("text")
    .attr("x", width/2)
    .attr("y", 20)
    .attr('class', 'lineLabel')
    .attr("display", "none")
    .html("");

  var line = d3.line()
    .x(d => x(d.year))
    .y(d => y(d.percent));

  let lines = svg.append('g');

  lines.selectAll('.line_group')
    .data(origData).enter()
    .append('path')
    .on('mouseover', function (d) {
      d3.selectAll('.line')
      .style("stroke", "gainsboro");
      id = "#"+d.name+"Line";
      d3.select(id)
      .style("stroke", "black")
      .style("stroke-width", "6px");
      d3.select(".lineLabel")
      .attr("display", "block")
      .style("text-anchor", "middle")
      .style("color", colors[titleMapping.get(id).num])
      .text(titleMapping.get(id).category);
    })
    .attr("onmouseout", "dehighlight()")
    .attr('class', function(d) {return 'line ' +d.name;})
    .attr('id', function(d) {return d.name+'Line';})
    .attr('d', d => line(d.values));

  var circleOpacity = '0.85';
var circleOpacityOnLineHover = "0.25"
var circleRadius = 3;
var circleRadiusHover = 6;


  lines.selectAll("circle-group")
  .data(origData).enter()
  .append("g")
  .style("fill", "black")
  .selectAll("circle")
  .data(d => d.values).enter()
  .append("g")
  .attr("class", "circle")  
  .on("mouseover", function(d) {
      d3.select(this)     
        .style("cursor", "pointer")
        .append("text")
        .attr("class", "text dataLabel")
        .text(`${d.percent}`)
        .attr("x", d => x(d.year) + 5)
        .attr("y", d => y(d.percent) - 10);
    })
  .on("mouseout", function(d) {
      d3.select(this)
        .style("cursor", "none")  
        .transition()
        .selectAll(".text").remove();
    })
  .append("circle")
  .attr("cx", d => x(d.year))
  .attr("cy", d => y(d.percent))
  .attr("r", circleRadius)
  .style('opacity', circleOpacity)
  .on("mouseover", function(d) {
        d3.select(this)
          .transition()
          .attr("r", circleRadiusHover);
      })
    .on("mouseout", function(d) {
        d3.select(this) 
          .transition()
          .attr("r", circleRadius);  
      });


  svg.append("path")
      .attr("d", "M 0 213 l 860 0")
      .style("stroke", "black");
  // Add the X Axis
  svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

  // Add the Y Axis
  svg.append("g")
      .call(d3.axisLeft(y));
</script>
</body>
</html>